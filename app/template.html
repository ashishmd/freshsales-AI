<!doctype html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
      <link rel="stylesheet" href="https://static.freshdev.io/fdk/2.0/assets/freshsales.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
      <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
      <script src="https://unpkg.com/anycontrol/dist/index.umd.min.js"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
      <script src="app.js"></script>
   </head>
   <body>
    <style>
      .custom-control-label::before{
        height: 16px;
        width: 28px !important;
        border-radius: 8px !important;
      }
      .custom-switch .custom-control-label::after {
        height: 12px;
        width: 12px;
      }
      .custom-switch {
        padding-left: 22px;
      }

      .custom-switch .custom-control-input:checked~.custom-control-label::after {
        transform: translateX(1.25rem);
      }
      .custom-control-input:checked~.custom-control-label::before {
        border-color: #ffaf14;
        background-color: #ffaf14;
      }

      .custom-control.custom-switch {
        display: flex;
        justify-content: center;
        margin-top: 50px;
      }
    </style>
    <div class="container">
        <div class="text-center">
          <button class="btn btn-primary" style="margin-top:20px">Start Zeus </button>
        </div>

        <div class="text-center">
          <button class="btn btn-primary" style="margin-top:20px">Stop Zeus </button>
        </div>
        <div class="custom-control custom-switch">
          <input type="checkbox" onclick="switchHandler(this)" value='off' class="custom-control-input" id="customSwitch1">
          <label class="custom-control-label" for="customSwitch1">
            <span style="padding-left: 10px;">Toggle Zeus</span>
          </label>
        </div>
    </div>
    <script>
      function switchHandler(event){
        if(event.value === 'off'){
          event.value = 'on';
          ctrl.start();
          return;
        }
        ctrl.stop();
        event.value = 'off';
        return;
      }
      function containsAny(str, substrings) {
        for (var i = 0; i != substrings.length; i++) {
          var substring = substrings[i];
          if (str.indexOf(substring) != - 1) {
            return substring;
          }
        }
        return null; 
      }

      function speak(speechText){
        try {
          var synth = window.speechSynthesis;
          if (synth.speaking) {
              console.error('speechSynthesis.speaking');
              return;
          }
          let voices = synth.getVoices().sort(function (a, b) {
              const aname = a.name.toUpperCase(), bname = b.name.toUpperCase();
              if ( aname < bname ) return -1;
              else if ( aname == bname ) return 0;
              else return +1;
          });
          if (speechText !== '') {
            var utterThis = new SpeechSynthesisUtterance(speechText);
            utterThis.onend = function (event) {
                console.log('SpeechSynthesisUtterance.onend');
            }
            utterThis.onerror = function (event) {
                console.error('SpeechSynthesisUtterance.onerror', event);
            }
            var selectedOption = "Fred";
            for(i = 0; i < voices.length ; i++) {
              if(voices[i].name === selectedOption) {
                utterThis.voice = voices[i];
                break;
              }
            }
            utterThis.rate = 1;
            utterThis.pitch = 0.6;
            synth.speak(utterThis);
          }
        } catch (error) {
          console.error(error); 
        }
      }

      var ctrl = new anycontrol();

      console.log({ctrl});
      // ctrl.addCommand("home", function() {
      //   console.log('Go to home page')
      // });

      ctrl.addCommand("kaise ho", function() {
        speak(`Badiya. Aap batao.`);
        client.interface.trigger("showNotify", {
          type: "info",
          message: `Badiya. Aap batao.`
        });
      });

      ctrl.addCommand("kya hua", function() {
        speak(`Kya hi hoga.`);

        client.interface.trigger("showNotify", {
          type: "info",
          message: `Kya hi hoga.`
        });
      });

      ctrl.addCommand("kya chal raha hai", function() {
        speak(`Mera to sahi he. Tumhara kat raha hai.`)
        client.interface.trigger("showNotify", {
          type: "info",
          message: `Mera to sahi he. Tumhara kat raha hai.`
        });
      });

      ctrl.addCommand("create", function(param) {
        createEntity(param);
      });

      ctrl.addCommand("create a", function(param) {
        createEntity(param);
      });


      function createEntity(param){
          let match = containsAny(param, ['lead', 'account', 'contact', 'deal']);
          if(match) {
            speak(`Let's create a ${param}`)
            client.interface.trigger("showNotify", {
              type: "info",
              message: `Let's create an ${param}`
            });
            client.interface.trigger("open", {
              id: param
            }).then(function(data) {
            }).catch(function(error) {
            });
          } else {
            speak(`Cannot create ${param}`)
            client.interface.trigger("showNotify", {
              type: "info",
              message: `Cannot create ${param}`
            });
          }
      }

      ctrl.addCommand("give me", async function(param) {
        speak(`Okay. Let me check ${param}`);
        client.interface.trigger("showNotify", {
          type: "info",
          message: `Okay. Let me check ${param}`
        })
        let editedParam = !!param ? param.replace(' ', '_'): param;
        console.log(editedParam);
        let {currentEntityInfo} = await client.data.get("currentEntityInfo")

        let {domainName} = await client.data.get("domainName");

        var headers = {"Authorization": "Token token=<%= (iparam.api_key) %>"};
        var options = { headers: headers };
        var url = "https://" + domainName + "/" + currentEntityInfo.currentEntityType + "s/" + (currentEntityInfo.currentEntityId || "12000593870") + ".json" ;
        try {
          let data = await client.request.get(url, options);
          let result = JSON.parse(data.response)[currentEntityInfo.currentEntityType][editedParam];
          console.log(JSON.parse(data.response)[currentEntityInfo.currentEntityType][editedParam]);
          if(!result){
            speak(`No results found for ${param}`)
            client.interface.trigger("showNotify", {
              type: "info",
              message: `No results found for ${param}`
            })
          } else {
            speak(result)
            client.interface.trigger("showNotify", {
              type: "info",
              message: result
            })
          }

        } catch(error){
          speak(error)
          client.interface.trigger("showNotify", {
            type: "info",
            message: error
          })
        }


      });

      ctrl.addCommand('add',function(param) {
        window.postMessage('add', 'https://ashishtestfs2.freshsales.io/')
        let match = containsAny(param, ['task', 'appointment']);
        // if(match) {
        //   // window.postMessage(param, 'https://ashishtestfs2.freshsales.io/')
        // } else {
        //   client.interface.trigger("showNotify", {
        //     type: "info",
        //     message: `Cannot add ${param}`
        //   });
        // }
      });
      ctrl.debug(true);
    </script>
   </body>
</html>
