<!doctype html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <link rel="stylesheet" href="https://static.freshdev.io/fdk/2.0/assets/freshsales.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
      <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
      <script src="https://unpkg.com/anycontrol/dist/index.umd.min.js"></script>
      <script src="app.js"></script>
   </head>
   <body>
      <div class="container">
         <div class="align-middle text-center" style="margin-top: 50px">
            This is your sample app. You can utilise this space to build your app.
            <br/>
            You can add your own element here.
            <br/><br/>
            Click on the below button.
         </div>
         <br/>
         <div class="text-center">
            <button onclick="openModal();" class="btn btn-primary" style="margin-top:20px">   Open Modal </button>
         </div>
      </div>

<script>
  function containsAny(str, substrings) {
    for (var i = 0; i != substrings.length; i++) {
       var substring = substrings[i];
       if (str.indexOf(substring) != - 1) {
         return substring;
       }
    }
    return null; 
  }

  var ctrl = new anycontrol();

  console.log({ctrl});
  // ctrl.addCommand("home", function() {
  //   console.log('Go to home page')
  // });

  ctrl.addCommand("kaise ho", function() {
    client.interface.trigger("showNotify", {
      type: "info",
      message: `Badiya. Aap batao.`
    });
  });

  ctrl.addCommand("kya hua", function() {
    client.interface.trigger("showNotify", {
      type: "info",
      message: `Kya hi hoga.`
    });
  });

  ctrl.addCommand("kya chal raha hai", function() {
    client.interface.trigger("showNotify", {
      type: "info",
      message: `Mera to sahi he. Tumhara kat raha hai.`
    });
  });

  ctrl.addCommand("create", function(param) {
    createEntity(param);
  });

  ctrl.addCommand("create a", function(param) {
    createEntity(param);
  });


  function createEntity(param){
      let match = containsAny(param, ['lead', 'account', 'contact', 'deal']);
      if(match) {
      client.interface.trigger("showNotify", {
        type: "info",
        message: `Let's create an ${param}`
      });
      client.interface.trigger("open", {
        id: param
      }).then(function(data) {
      }).catch(function(error) {
      });
    } else {
      client.interface.trigger("showNotify", {
        type: "info",
        message: `Cannot create ${param}`
      });
    }
  }

  ctrl.addCommand("give me", async function(param) {
    client.interface.trigger("showNotify", {
      type: "info",
      message: `Okay. Let me check ${param}`
    })
    // console.log(param)
    let editedParam = !!param ? param.replace(' ', '_'): param;
    console.log(editedParam);
    let {currentEntityInfo} = await client.data.get("currentEntityInfo")
    // console.log(currentEntityInfo);

    let {domainName} = await client.data.get("domainName");
    // console.log(domainName);

    var headers = {"Authorization": "Token token=<%= (iparam.api_key) %>"};
    var options = { headers: headers };
    var url = "https://" + domainName + "/" + currentEntityInfo.currentEntityType + "s/" + (currentEntityInfo.currentEntityId || "12000593870") + ".json" ;
    // console.log(url);
    // console.log(options);
    try {
      let data = await client.request.get(url, options);
      // console.log(JSON.parse(data.response));
      let result = JSON.parse(data.response)[currentEntityInfo.currentEntityType][editedParam];
      console.log(JSON.parse(data.response)[currentEntityInfo.currentEntityType][editedParam]);
      if(!result){
        client.interface.trigger("showNotify", {
          type: "info",
          message: `No results found for ${param}`
        })
      } else {
        client.interface.trigger("showNotify", {
          type: "info",
          message: result
        })
      }

    } catch(error){
      client.interface.trigger("showNotify", {
        type: "info",
        message: error
      })
    }


  });

  ctrl.addCommand('add',function(param) {
    window.postMessage('add', 'https://ashishtestfs2.freshsales.io/')
    let match = containsAny(param, ['task', 'appointment']);
    // if(match) {
    //   // window.postMessage(param, 'https://ashishtestfs2.freshsales.io/')
    // } else {
    //   client.interface.trigger("showNotify", {
    //     type: "info",
    //     message: `Cannot add ${param}`
    //   });
    // }
  });
  ctrl.debug(true);

  ctrl.start();
  // ctrl.stop();
</script>
   </body>
</html>
